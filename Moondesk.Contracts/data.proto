syntax = "proto3";

package aquapp.data;

// Used for API calls that don't require any input parameters.
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";

// --- ENUMS ---

// Status of an asset
enum AssetStatus {
  ASSET_STATUS_UNKNOWN = 0;
  ASSET_STATUS_ONLINE = 1;
  ASSET_STATUS_OFFLINE = 2;
  ASSET_STATUS_WARNING = 3;
  ASSET_STATUS_CRITICAL = 4;
  ASSET_STATUS_MAINTENANCE = 5;
}

// Type of sensor
enum SensorType {
  SENSOR_TYPE_TEMPERATURE = 0;
  SENSOR_TYPE_PRESSURE = 1;
  SENSOR_TYPE_VIBRATION = 2;
  SENSOR_TYPE_FLOW_RATE = 3;
  SENSOR_TYPE_LEVEL = 4;
  SENSOR_TYPE_HUMIDITY = 5;
  SENSOR_TYPE_POWER = 6;
  SENSOR_TYPE_SPEED = 7;
  SENSOR_TYPE_PH = 8;
  SENSOR_TYPE_CONDUCTIVITY = 9;
  SENSOR_TYPE_ANALOG_IN = 10; // Generic analog input
  SENSOR_TYPE_DIGITAL_IN = 11; // Generic digital input (on/off)
  SENSOR_TYPE_CUSTOM = 99;
}

// State of an outgoing command
enum CommandStatus {
  COMMAND_STATUS_PENDING = 0;
  COMMAND_STATUS_SENT = 1;
  COMMAND_STATUS_DELIVERED = 2;
  COMMAND_STATUS_ACKNOWLEDGED = 3;
  COMMAND_STATUS_EXECUTING = 4;
  COMMAND_STATUS_SUCCESS = 5;
  COMMAND_STATUS_FAILED = 6;
  COMMAND_STATUS_TIMEOUT = 7;
}

// Quality of a sensor reading
enum ReadingQuality {
  READING_QUALITY_GOOD = 0;
  READING_QUALITY_UNCERTAIN = 1;
  READING_QUALITY_BAD = 2;
  READING_QUALITY_SIMULATED = 3;
  VALUE_QUALITY_STALE = 4; // Data is old or was not updated
}

// Severity level of an alert
enum AlertSeverity {
  ALERT_SEVERITY_INFO = 0;
  ALERT_SEVERITY_WARNING = 1;
  ALERT_SEVERITY_CRITICAL = 2;
  ALERT_SEVERITY_EMERGENCY = 3;
}

// --- DATA MESSAGES ---

// Metadata for a monitored asset (a pump, a tank, a pipe section)
message Asset {
  int32 id = 1;
  string name = 2;
  string type = 3;                              // e.g., "Pump", "Tank", "Valve"
  string location = 4;
  AssetStatus status = 5;
  google.protobuf.Timestamp last_seen = 6;
  string description = 7;
  string manufacturer = 8;
  string model_number = 9;
  google.protobuf.Timestamp installation_date = 10;
  repeated Sensor sensors = 11;
}

// Metadata for a sensor attached to an asset
message Sensor {
  int32 id = 1;
  int32 asset_id = 2;
  string name = 3;
  SensorType type = 4;
  string unit = 5;                              // e.g., "Â°C", "PSI", "Hz"
  optional double threshold_low = 6;
  optional double threshold_high = 7;
  optional double min_value = 8;
  optional double max_value = 9;
  int32 sampling_interval_ms = 10;
  bool is_active = 11;
  string description = 12;
  string native_address = 13; // NEW: Device-specific address (e.g., Modbus register, OPC UA NodeID)
}

// A single time-series reading from a sensor
message SensorReading {
  int64 id = 1;
  int32 sensor_id = 2;
  google.protobuf.Timestamp timestamp = 3;
  double value = 4;
  ReadingQuality quality = 5;
  string notes = 6;
}

// NEW: A calculated Key Performance Indicator (KPI) or aggregated metric
message CalculatedMetric {
  int64 id = 1;
  int32 asset_id = 2;
  google.protobuf.Timestamp timestamp = 3;
  string name = 4;                        // e.g., "OEE", "MTBF", "CyclesPerHour"
  double value = 5;
  string unit = 6;
  ReadingQuality quality = 7;
  string calculation_method = 8; // NEW: Stores the name or reference of the calculation logic
}

// An alert triggered when sensor readings exceed thresholds
message Alert {
  int32 id = 1;
  int32 sensor_id = 2;
  string source_type = 12;                // NEW: Explicitly state "Sensor" or "Metric"
  google.protobuf.Timestamp timestamp = 3;
  AlertSeverity severity = 4;
  string message = 5;
  double trigger_value = 6;
  optional double threshold_value = 7;
  bool acknowledged = 8;
  google.protobuf.Timestamp acknowledged_at = 9;
  string acknowledged_by = 10;
  string notes = 11;
}

// --- 3. CONTROL & CONFIGURATION MESSAGES ---

// NEW: A command sent to an asset or sensor for remote control
message AssetCommand {
  int64 command_id = 1;
  int32 asset_id = 2;
  string command_name = 3;              // e.g., "StartPump", "SetSpeed", "ResetFault"
  google.protobuf.Timestamp created_at = 4;
  CommandStatus status = 5;
  optional google.protobuf.Timestamp completed_at = 6;

  // Use map or Struct for flexible parameters, Struct is generally better for complex/nested data
  google.protobuf.Struct parameters = 7; // NEW: Key-value parameters for the command (e.g., {"speed_percent": 50.0})

  optional string device_response = 8;  // Response message from the physical device
}

// NEW: Message for reporting or updating the device configuration
message Configuration {
  int32 asset_id = 1;
  google.protobuf.Timestamp timestamp = 2; // When this configuration was reported/set
  string version = 3;                     // Configuration version identifier (e.g., firmware version, config ID)

  // Use Struct to hold the configuration data (e.g., PID settings, network info)
  google.protobuf.Struct config_data = 4;
}

message Command {
  int32 asset_id = 1;
  string command_name = 2;
  map<string, string> parameters = 3;
}