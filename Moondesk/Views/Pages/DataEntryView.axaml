<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:pages="clr-namespace:AquaPP.ViewModels.Pages"
             xmlns:i="https://github.com/projektanker/icons.avalonia"
             xmlns:suki="https://github.com/kikipoulet/SukiUI"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="AquaPP.Views.Pages.DataEntryView"
             x:DataType="pages:DataEntryViewModel">

    <UserControl.Styles>
        <!-- Keep only view-specific styles, DataGrid styles are now global -->
        <Style Selector="DataGridRow">
            <Setter Property="Height" Value="48" />
        </Style>
        
        <Style Selector="Button.ActionButton">
            <Setter Property="Height" Value="36" />
            <Setter Property="Padding" Value="16,0" />
            <Setter Property="CornerRadius" Value="6" />
        </Style>
        
        <Style Selector="Button.PrimaryAction">
            <Setter Property="Background" Value="{DynamicResource SukiPrimaryColor}" />
            <Setter Property="Foreground" Value="White" />
        </Style>
    </UserControl.Styles>

    <Design.DataContext>
        <pages:DataEntryViewModel />
    </Design.DataContext>

    <Grid RowDefinitions="Auto,*,Auto" Margin="20">
        <!-- Header Section -->
        <suki:GlassCard Grid.Row="0" Margin="0,0,0,16">
            <Grid ColumnDefinitions="Auto,*,Auto" Height="60">
                <!-- Title -->
                <StackPanel Grid.Column="0" VerticalAlignment="Center" Spacing="4">
                    <TextBlock Text="Water Quality Data Entry" 
                               FontWeight="Bold" 
                               FontSize="20"
                               Foreground="{DynamicResource SukiText}" />
                    <TextBlock Text="Record and manage water quality measurements" 
                               FontSize="12"
                               Foreground="{DynamicResource SukiLowText}" />
                </StackPanel>
                
                <!-- Date Picker -->
                <StackPanel Grid.Column="2" 
                            Orientation="Horizontal" 
                            Spacing="12"
                            VerticalAlignment="Center">
                    <i:Icon Value="fa-solid fa-calendar" 
                            FontSize="18"
                            Foreground="{DynamicResource SukiPrimaryColor}"
                            VerticalAlignment="Center" />
                    <CalendarDatePicker SelectedDate="{Binding CurrentDate, Mode=TwoWay}"
                                        CustomDateFormatString="MMMM dd, yyyy"
                                        Width="200">
                        <Interaction.Behaviors>
                            <EventTriggerBehavior EventName="SelectedDateChanged">
                                <InvokeCommandAction Command="{Binding SelectedDateChangedCommand}" />
                            </EventTriggerBehavior>
                        </Interaction.Behaviors>
                    </CalendarDatePicker>
                </StackPanel>
            </Grid>
        </suki:GlassCard>

        <!-- Data Grid Section -->
        <suki:GlassCard Grid.Row="1">
            <Grid>
                <DataGrid
                    x:Name="ReadingsDataGrid"
                    ItemsSource="{Binding Readings}"
                    IsVisible="{Binding !ShowNoDataMessage}"
                    AutoGenerateColumns="False"
                    IsReadOnly="False"
                    SelectionMode="Extended"
                    SelectionChanged="OnDataGridSelectionChanged"
                    HeadersVisibility="Column"
                    PointerPressed="DataGridPointerPressed"
                    HorizontalScrollBarVisibility="Auto"
                    VerticalScrollBarVisibility="Auto"
                    Background="Transparent"
                    BorderThickness="0">

                    <DataGrid.Columns>
                        <DataGridTextColumn
                            Binding="{Binding SampleId}"
                            Width="160">
                            <DataGridTextColumn.Header>
                                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                    <i:Icon Value="fa-solid fa-key" />
                                    <TextBlock Text="Sample ID" />
                                </StackPanel>
                            </DataGridTextColumn.Header>
                        </DataGridTextColumn>
                        
                        <DataGridTextColumn
                            Binding="{Binding Timestamp, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}"
                            Width="170">
                            <DataGridTextColumn.Header>
                                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                    <i:Icon Value="fa-solid fa-clock" />
                                    <TextBlock Text="Timestamp" />
                                </StackPanel>
                            </DataGridTextColumn.Header>
                        </DataGridTextColumn>

                        <DataGridTextColumn 
                            Binding="{Binding Location}" 
                            Width="*" 
                            MinWidth="120">
                            <DataGridTextColumn.Header>
                                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                    <i:Icon Value="fa-solid fa-map-marker-alt" />
                                    <TextBlock Text="Location" />
                                </StackPanel>
                            </DataGridTextColumn.Header>
                        </DataGridTextColumn>

                        <DataGridTextColumn 
                            Binding="{Binding PH}" 
                            Width="90">
                            <DataGridTextColumn.Header>
                                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                    <i:Icon Value="fa-solid fa-flask" />
                                    <TextBlock Text="pH" />
                                </StackPanel>
                            </DataGridTextColumn.Header>
                        </DataGridTextColumn>

                        <DataGridTextColumn 
                            Binding="{Binding Conductivity}" 
                            Width="140">
                            <DataGridTextColumn.Header>
                                <StackPanel Orientation="Vertical" Spacing="4">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <i:Icon Value="fa-solid fa-bolt" />
                                        <TextBlock Text="Conductivity" />
                                    </StackPanel>
                                    <ComboBox ItemsSource="{Binding ConductivityUnits}"
                                              SelectedItem="{Binding SelectedConductivityUnit}"
                                              MinWidth="100"
                                              FontSize="11">
                                        <Interaction.Behaviors>
                                            <EventTriggerBehavior EventName="SelectionChanged">
                                                <InvokeCommandAction Command="{Binding UpdateConductivityUnitCommand}"
                                                                     CommandParameter="{Binding SelectedConductivityUnit}"/>
                                            </EventTriggerBehavior>
                                        </Interaction.Behaviors>
                                    </ComboBox>
                                </StackPanel>
                            </DataGridTextColumn.Header>
                        </DataGridTextColumn>

                        <DataGridTextColumn 
                            Binding="{Binding Turbidity}" 
                            Width="130">
                            <DataGridTextColumn.Header>
                                <StackPanel Orientation="Vertical" Spacing="4">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <i:Icon Value="fa-solid fa-cloud" />
                                        <TextBlock Text="Turbidity" />
                                    </StackPanel>
                                    <ComboBox ItemsSource="{Binding TurbidityUnits}"
                                              SelectedItem="{Binding SelectedTurbidityUnit}"
                                              MinWidth="90"
                                              FontSize="11">
                                        <Interaction.Behaviors>
                                            <EventTriggerBehavior EventName="SelectionChanged">
                                                <InvokeCommandAction Command="{Binding UpdateTurbidityUnitCommand}"
                                                                     CommandParameter="{Binding SelectedTurbidityUnit}"/>
                                            </EventTriggerBehavior>
                                        </Interaction.Behaviors>
                                    </ComboBox>
                                </StackPanel>
                            </DataGridTextColumn.Header>
                        </DataGridTextColumn>

                        <DataGridTextColumn 
                            Binding="{Binding ChlorineResidual}" 
                            Width="160">
                            <DataGridTextColumn.Header>
                                <StackPanel Orientation="Vertical" Spacing="4">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <i:Icon Value="fa-solid fa-vial" />
                                        <TextBlock Text="Chlorine" />
                                    </StackPanel>
                                    <ComboBox ItemsSource="{Binding ChlorineUnits}"
                                              SelectedItem="{Binding SelectedChlorineUnit}"
                                              MinWidth="90"
                                              FontSize="11">
                                        <Interaction.Behaviors>
                                            <EventTriggerBehavior EventName="SelectionChanged">
                                                <InvokeCommandAction Command="{Binding UpdateChlorineUnitCommand}"
                                                                     CommandParameter="{Binding SelectedChlorineUnit}" />
                                            </EventTriggerBehavior>
                                        </Interaction.Behaviors>
                                    </ComboBox>
                                </StackPanel>
                            </DataGridTextColumn.Header>
                        </DataGridTextColumn>

                        <DataGridTextColumn 
                            Binding="{Binding Notes}" 
                            Width="*" 
                            MinWidth="180">
                            <DataGridTextColumn.Header>
                                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                    <i:Icon Value="fa-solid fa-clipboard" />
                                    <TextBlock Text="Notes" />
                                </StackPanel>
                            </DataGridTextColumn.Header>
                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>
                
                <!-- Empty State -->
                <StackPanel HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Spacing="16"
                            IsVisible="{Binding ShowNoDataMessage}">
                    <i:Icon Value="fa-solid fa-droplet-slash" 
                            FontSize="64"
                            Foreground="{DynamicResource SukiLowText}"
                            HorizontalAlignment="Center" />
                    <TextBlock Text="No readings found for the selected date"
                               FontSize="18"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource SukiText}"
                               HorizontalAlignment="Center" />
                    <TextBlock Text="Click 'Add Row' to create a new reading"
                               FontSize="13"
                               Foreground="{DynamicResource SukiLowText}"
                               HorizontalAlignment="Center" />
                </StackPanel>
            </Grid>
        </suki:GlassCard>

        <!-- Action Bar -->
        <suki:GlassCard Grid.Row="2" Margin="0,16,0,0">
            <Grid ColumnDefinitions="*,Auto" Height="56">
                <!-- Left Actions -->
                <StackPanel Grid.Column="0" 
                            Orientation="Horizontal" 
                            Spacing="12"
                            VerticalAlignment="Center">
                    <Button Classes="ActionButton PrimaryAction" 
                            Command="{Binding AddBlankReadingRowCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <i:Icon Value="fa-solid fa-plus" FontSize="14" />
                            <TextBlock Text="Add Row" />
                        </StackPanel>
                    </Button>
                    
                    <Button Classes="ActionButton" 
                            Command="{Binding DeleteSelectedReadingsCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <i:Icon Value="fa-solid fa-trash" FontSize="14" />
                            <TextBlock Text="Delete Selected" />
                        </StackPanel>
                    </Button>
                    
                    <Button Classes="ActionButton" 
                            Command="{Binding SaveReadingsCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <i:Icon Value="fa-solid fa-floppy-disk" FontSize="14" />
                            <TextBlock Text="Save" />
                        </StackPanel>
                    </Button>
                </StackPanel>
                
                <!-- Right Actions -->
                <StackPanel Grid.Column="1" 
                            Orientation="Horizontal" 
                            Spacing="12"
                            VerticalAlignment="Center">
                    <Button Classes="ActionButton" 
                            Command="{Binding LoadCurrentDateReadingsCommand}"
                            ToolTip.Tip="Load readings for selected date">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <i:Icon Value="fa-solid fa-calendar-day" FontSize="14" />
                            <TextBlock Text="Load Today" />
                        </StackPanel>
                    </Button>
                    
                    <Button Classes="ActionButton" 
                            Command="{Binding LoadAllReadingsCommand}"
                            ToolTip.Tip="Load all readings">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <i:Icon Value="fa-solid fa-database" FontSize="14" />
                            <TextBlock Text="Load All" />
                        </StackPanel>
                    </Button>
                    
                    <Button Classes="ActionButton" 
                            Command="{Binding ExportReadingsCommand}"
                            ToolTip.Tip="Export to CSV">
                        <Button.CommandParameter>
                            <Binding RelativeSource="{RelativeSource Self}" />
                        </Button.CommandParameter>
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <i:Icon Value="fa-solid fa-file-export" FontSize="14" />
                            <TextBlock Text="Export" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </suki:GlassCard>
    </Grid>

</UserControl>
